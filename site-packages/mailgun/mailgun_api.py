__all__ = ['MailGunAPI']

import json
from functools import wraps
from typing import Dict

import requests

ENDPOINT = 'https://api.mailgun.net'


def handle_error(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        r = f(*args, **kwargs)

        if not r.ok:
            print('- - - - Req Content - - - -')
            print(r.content)
            raise Exception(f'Unexceptd HTTP Error: {r.status_code}')

        if 'application/json' in r.headers.get('content-type', '').split(';'):
            if 'error' in (data := r.json()):
                raise Exception(data['error'])
            return data

        return r

    return decorated


def _build_message(subject: str, to: str, template: str, values: Dict[str, str]):
    data = {f'v:{k}': v for k, v in values.items()}

    data['to'] = to
    data['subject'] = subject
    data['template'] = template

    return data


class MailGunAPI():
    def __init__(self, config):
        self.domain = config['domain']
        self.endpoint = config.get('endpoint', ENDPOINT)

        self.send_from = f'{config["sender_name"]} <no-reply@{self.domain}>'
        self.auth = ('api', config['api_key'])

    @handle_error
    def send(self, subject, to, template, values):
        maildata = _build_message(subject, to, template, values)
        maildata['from'] = self.send_from
        r = requests.post(url=f'{self.endpoint}/v3/{self.domain}/messages',
                          auth=self.auth,
                          data=maildata)
        return r

    @handle_error
    def check_adr(self, address: str):
        r = requests.get(url=f'{self.endpoint}/v4/address/validate',
                         auth=self.auth,
                         params={'address': address})
        return r
